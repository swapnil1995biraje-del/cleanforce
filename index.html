<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CleanCalc Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#f0f4f8;--white:#fff;--navy:#0f1e35;
  --teal:#0cb8a0;--teal-d:#0a9e88;--teal-light:#e6faf7;
  --orange:#f46b2b;--orange-light:#fff1ea;
  --green:#1fba74;--green-light:#e7faf2;
  --yellow:#f5a623;
  --purple-light:#f3f0ff;
  --muted:#6b7a90;--border:#dde3ec;--text:#1a2740;
  --radius:14px;--shadow:0 2px 12px rgba(0,0,0,.07)
}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;min-height:100vh;padding-bottom:90px}

/* HEADER */
.header{background:var(--navy);padding:13px 15px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:300}
.hicon{width:34px;height:34px;background:var(--teal);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.header h1{font-size:16px;font-weight:800;color:#fff;letter-spacing:-.3px}
.header p{font-size:10px;color:rgba(255,255,255,.4);font-family:'JetBrains Mono',monospace;margin-top:1px}
#hbadge{margin-left:auto;font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;font-family:'JetBrains Mono',monospace;white-space:nowrap;border:1px solid transparent;transition:all .3s}
#hbadge.synced{background:#1fba7420;border-color:#1fba7440;color:#1fba74}
#hbadge.syncing{background:#f5a62320;border-color:#f5a62340;color:#f5a623}
#hbadge.local{background:#f5a62320;border-color:#f5a62340;color:#f5a623}
#hbadge.empty{background:#f46b2b20;border-color:#f46b2b40;color:#f46b2b}
#hbadge.error{background:#e53e3e20;border-color:#e53e3e40;color:#e53e3e}

/* TABS */
.tab-bar{background:var(--white);display:flex;border-bottom:2px solid var(--border);position:sticky;top:57px;z-index:200}
.tab-btn{flex:1;padding:9px 3px 7px;text-align:center;font-size:10px;font-weight:700;color:var(--muted);background:none;border:none;border-bottom:3px solid transparent;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;line-height:1.3;margin-bottom:-2px}
.tab-btn .ti{font-size:15px;display:block;margin-bottom:2px}
.tab-btn.active{color:var(--teal);border-bottom-color:var(--teal)}
.tab-panel{display:none;padding:12px 12px 0}
.tab-panel.active{display:block}

/* SECTION LABEL */
.slabel{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin:14px 0 7px;display:flex;align-items:center;gap:6px}
.slabel:first-child{margin-top:4px}
.snum{width:18px;height:18px;background:var(--teal);border-radius:50%;font-size:10px;font-weight:800;color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* CARD */
.card{background:var(--white);border-radius:var(--radius);padding:14px;margin-bottom:10px;box-shadow:var(--shadow);border:1px solid var(--border)}

/* FIELDS */
.field{margin-bottom:11px}
.field:last-child{margin-bottom:0}
.field label{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:600;color:var(--muted);margin-bottom:4px}
.hint{font-size:11px;color:var(--muted);margin-top:3px}
.gst-badge{background:#fff3e0;color:#e65100;font-size:10px;font-weight:700;padding:1px 5px;border-radius:4px;font-family:'JetBrains Mono',monospace;border:1px solid #fdc896}
.auto-badge{background:var(--teal-light);color:var(--teal-d);font-size:10px;font-weight:700;padding:1px 5px;border-radius:4px;font-family:'JetBrains Mono',monospace;border:1px solid #a0ded7}

/* INPUTS */
.iw{position:relative}
.iw .px,.iw .sx{position:absolute;top:50%;transform:translateY(-50%);font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--muted);pointer-events:none}
.iw .px{left:11px}.iw .sx{right:11px}
.iw.px-in input{padding-left:26px}
.iw.sx-in input{padding-right:40px}
input[type="number"],select{width:100%;padding:10px 12px;font-size:15px;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--text);background:var(--bg);border:1.5px solid var(--border);border-radius:10px;outline:none;-webkit-appearance:none;appearance:none}
input[type="number"]:focus{border-color:var(--teal);background:#fff}
input.res{background:var(--teal-light);border-color:#a0ded7;color:#0a7a6e;font-weight:700}

.two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* DB PRODUCT CARD */
.db-card{background:var(--white);border-radius:var(--radius);border:1px solid var(--border);margin-bottom:10px;box-shadow:var(--shadow);overflow:hidden}
.db-head{padding:10px 13px;display:flex;align-items:center;gap:8px}
.db-icon{font-size:18px}
.db-name{font-size:14px;font-weight:800;color:#fff;flex:1}
.db-status{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;font-family:'JetBrains Mono',monospace}
.db-status.ok{background:rgba(31,186,116,.2);color:#1fba74;border:1px solid rgba(31,186,116,.3)}
.db-status.empty{background:rgba(244,107,43,.2);color:#f46b2b;border:1px solid rgba(244,107,43,.3)}
.db-body{padding:13px}
.db-computed{background:var(--navy);border-radius:10px;padding:12px;margin-top:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;text-align:center}
.dc-l{font-size:9px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.8px;margin-bottom:3px}
.dc-v{font-size:14px;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1.1;color:#fff}
.dc-v.tc{color:var(--teal)}.dc-v.oc{color:#ffaa77}.dc-v.gc{color:#1fba74}

/* PRODUCT HEAD COLORS */
.head-floor{background:linear-gradient(135deg,#1a3a5c,#0f1e35)}
.head-dish{background:linear-gradient(135deg,#0a5c4a,#0cb8a0)}
.head-bath{background:linear-gradient(135deg,#4a1a5c,#7c3aed)}
.head-toilet{background:linear-gradient(135deg,#5c2a0a,#f46b2b)}
.head-hand{background:linear-gradient(135deg,#1a4a2a,#1fba74)}

/* SAVE / SHARE */
.save-btn{width:100%;padding:14px;background:var(--teal);color:#fff;border:none;border-radius:11px;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.save-btn:active{background:var(--teal-d)}
#save-msg{text-align:center;font-size:12px;font-weight:700;margin-top:8px;display:none;padding:4px 0}
.share-box{background:var(--white);border-radius:var(--radius);border:1px solid var(--border);padding:14px;margin-top:10px;box-shadow:var(--shadow)}
.share-title{font-size:13px;font-weight:800;color:var(--text);margin-bottom:4px}
.share-desc{font-size:12px;color:var(--muted);margin-bottom:11px;line-height:1.6}
.share-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.sbtn{display:flex;align-items:center;justify-content:center;padding:11px 8px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;border:none}
.sbtn.exp{background:var(--navy);color:#fff}
.sbtn.imp{background:var(--teal-light);color:var(--teal-d);border:1.5px solid var(--teal)}
.cloud-note{background:var(--purple-light);border:1px solid #c4b5fd;border-radius:10px;padding:10px 12px;font-size:12px;color:#5b21b6;line-height:1.65;margin-top:10px}
#import-msg{font-size:12px;font-weight:700;text-align:center;margin-top:6px;display:none}

/* PACK BUTTONS */
.pack-row{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-bottom:10px}
.pb{padding:7px 2px;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;font-size:10px;font-weight:700;color:var(--muted);text-align:center;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;line-height:1.4}
.pb .pbml{font-size:12px;font-weight:800;display:block;color:var(--text)}
.pb.sel{background:var(--teal);border-color:var(--teal);color:#fff}
.pb.sel .pbml{color:#fff}

/* PRODUCT SELECTOR */
.prod-selector{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:12px}
.psel-btn{padding:8px 3px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;font-size:10px;font-weight:700;color:var(--muted);text-align:center;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;line-height:1.4}
.psel-btn .pi{font-size:17px;display:block;margin-bottom:2px}
.psel-btn.sel{border-color:var(--teal);background:var(--teal-light);color:var(--teal-d)}
.psel-btn.unset{opacity:.4}

/* FETCHED STRIP */
.fetched-strip{background:var(--navy);border-radius:11px;padding:12px 13px;margin-bottom:12px}
.fs-title{font-size:10px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-family:'JetBrains Mono',monospace}
.fr{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.06)}
.fr:last-child{border-bottom:none}
.fl{font-size:12px;color:rgba(255,255,255,.5);font-weight:500}
.fv{font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#fff}
.fv.tc{color:var(--teal)}.fv.oc{color:#ffaa77}.fv.gc{color:#1fba74}

/* NOT CONFIGURED */
.not-configured{background:#f8fafc;border:1.5px dashed var(--border);border-radius:11px;padding:16px;text-align:center;margin-bottom:12px}
.not-configured p{font-size:12px;color:var(--muted);font-weight:600}
.nc-btn{margin-top:8px;padding:8px 16px;background:var(--teal);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif}

/* RESULT ROWS */
.rrow{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.rrow:last-child{border-bottom:none}
.rl{font-size:13px;color:var(--muted);font-weight:500}
.rv{font-size:14px;font-weight:700;font-family:'JetBrains Mono',monospace}
.rv.tc{color:var(--teal)}.rv.oc{color:var(--orange)}.rv.gc{color:var(--green)}

/* RESULT PILLS */
.rpills{display:flex;gap:8px;margin-top:12px}
.rpill{flex:1;border-radius:12px;padding:12px 7px;text-align:center}
.rpill.tp{background:var(--teal-light)}.rpill.op{background:var(--orange-light)}.rpill.gp{background:var(--green-light)}
.rpl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
.rpill.tp .rpl{color:#0a8a78}.rpill.op .rpl{color:#c04a10}.rpill.gp .rpl{color:#0d8a52}
.rpv{font-size:18px;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1.1}
.rpill.tp .rpv{color:var(--teal)}.rpill.op .rpv{color:var(--orange)}.rpill.gp .rpv{color:var(--green)}
.rps{font-size:10px;color:var(--muted);margin-top:3px}

/* LITRE BOX */
.litre-box{background:#fff8f0;border:1px solid #fddbb4;border-radius:10px;padding:11px 13px;margin-top:11px;font-size:12.5px;line-height:1.75;color:#7a4a1e}
.litre-box strong{font-weight:700}

/* HOW BOX */
.how-box{background:#f5f7fa;border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:10px;font-size:12px;color:var(--muted);line-height:1.7}
.how-box strong{color:var(--text)}

/* INFO PILL */
.info-pill{background:var(--teal-light);border:1px solid #a0ded7;border-radius:10px;padding:10px 13px;margin-bottom:10px;font-size:12px;color:#0a7a6e;font-weight:600;line-height:1.6}

/* ADD BUTTON */
.add-btn{width:100%;padding:13px;background:var(--white);color:var(--teal);border:2px dashed var(--teal);border-radius:12px;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:10px}

/* BUNDLE PRODUCT CARD */
.bpcard{background:var(--white);border-radius:var(--radius);border:1px solid var(--border);margin-bottom:10px;box-shadow:var(--shadow);overflow:hidden}
.bphead{padding:10px 13px;display:flex;align-items:center;gap:8px}
.bpnum{width:22px;height:22px;background:rgba(255,255,255,.15);border-radius:50%;font-size:11px;font-weight:800;color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.bphead select{background:transparent;border:none;color:#fff;font-size:13px;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;outline:none;flex:1;padding:0;margin:0}
.rmbtn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.7);border-radius:6px;padding:5px 9px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;flex-shrink:0}
.bpbody{padding:13px}
.bp-mini{background:#f5f7fa;border:1px solid var(--border);border-radius:9px;padding:9px 11px;margin-bottom:11px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;text-align:center}
.bm-l{font-size:9px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.6px;margin-bottom:2px}
.bm-v{font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--text)}
.bm-v.tc{color:var(--teal)}
.prod-result{background:var(--teal-light);border-radius:9px;padding:9px 11px;margin-top:9px;display:flex;justify-content:space-between;align-items:center}
.prl{font-size:11px;color:#0a7a6e;font-weight:600}
.prv{font-size:14px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--teal)}
</style>
</head>
<body>

<div class="header">
  <div class="hicon">‚öóÔ∏è</div>
  <div><h1>CleanCalc Pro</h1><p>Hotel Powder Supply</p></div>
  <span id="hbadge" class="empty">DB Empty</span>
</div>

<div class="tab-bar">
  <button class="tab-btn active" onclick="showTab('db',this)"><span class="ti">üóÑÔ∏è</span>Products DB</button>
  <button class="tab-btn" onclick="showTab('single',this)"><span class="ti">üß™</span>Per Sachet</button>
  <button class="tab-btn" onclick="showTab('bulk',this)"><span class="ti">üì¶</span>Bulk Order</button>
  <button class="tab-btn" onclick="showTab('bundle',this)"><span class="ti">üõí</span>Bundle</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: PRODUCTS DB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-db" class="tab-panel active">
  <div class="info-pill">üóÑÔ∏è Set costs here once ‚Äî all other tabs auto-fill when you select a product.</div>

  <div class="db-card">
    <div class="db-head head-floor"><span class="db-icon">üßπ</span><span class="db-name">Floor Cleaner</span><span class="db-status empty" id="dbs-0">Not Set</span></div>
    <div class="db-body">
      <div class="two-col">
        <div class="field"><label>Price/kg <span class="gst-badge">excl.GST</span></label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-pkg-0" placeholder="45" oninput="liveDB(0)"></div></div>
        <div class="field"><label>Stock in hand</label><div class="iw sx-in"><input type="number" id="db-stock-0" placeholder="25" oninput="liveDB(0)"><span class="sx">kg</span></div></div>
        <div class="field"><label>Grams per litre</label><div class="iw sx-in"><input type="number" id="db-gpl-0" placeholder="80" oninput="liveDB(0)"><span class="sx">g/L</span></div></div>
        <div class="field"><label>Mfg cost/sachet</label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-mfg-0" placeholder="2.00" oninput="liveDB(0)"></div></div>
      </div>
      <div class="db-computed">
        <div><div class="dc-l">‚Çπ/kg+GST</div><div class="dc-v tc" id="dc-gst-0">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Cost/litre</div><div class="dc-v" id="dc-litre-0">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Stock Value</div><div class="dc-v oc" id="dc-stock-0">‚Çπ‚Äî</div></div>
      </div>
    </div>
  </div>

  <div class="db-card">
    <div class="db-head head-dish"><span class="db-icon">üçΩÔ∏è</span><span class="db-name">Dish Wash</span><span class="db-status empty" id="dbs-1">Not Set</span></div>
    <div class="db-body">
      <div class="two-col">
        <div class="field"><label>Price/kg <span class="gst-badge">excl.GST</span></label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-pkg-1" placeholder="55" oninput="liveDB(1)"></div></div>
        <div class="field"><label>Stock in hand</label><div class="iw sx-in"><input type="number" id="db-stock-1" placeholder="20" oninput="liveDB(1)"><span class="sx">kg</span></div></div>
        <div class="field"><label>Grams per litre</label><div class="iw sx-in"><input type="number" id="db-gpl-1" placeholder="60" oninput="liveDB(1)"><span class="sx">g/L</span></div></div>
        <div class="field"><label>Mfg cost/sachet</label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-mfg-1" placeholder="2.00" oninput="liveDB(1)"></div></div>
      </div>
      <div class="db-computed">
        <div><div class="dc-l">‚Çπ/kg+GST</div><div class="dc-v tc" id="dc-gst-1">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Cost/litre</div><div class="dc-v" id="dc-litre-1">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Stock Value</div><div class="dc-v oc" id="dc-stock-1">‚Çπ‚Äî</div></div>
      </div>
    </div>
  </div>

  <div class="db-card">
    <div class="db-head head-bath"><span class="db-icon">üöø</span><span class="db-name">Bathroom Cleaner</span><span class="db-status empty" id="dbs-2">Not Set</span></div>
    <div class="db-body">
      <div class="two-col">
        <div class="field"><label>Price/kg <span class="gst-badge">excl.GST</span></label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-pkg-2" placeholder="50" oninput="liveDB(2)"></div></div>
        <div class="field"><label>Stock in hand</label><div class="iw sx-in"><input type="number" id="db-stock-2" placeholder="15" oninput="liveDB(2)"><span class="sx">kg</span></div></div>
        <div class="field"><label>Grams per litre</label><div class="iw sx-in"><input type="number" id="db-gpl-2" placeholder="70" oninput="liveDB(2)"><span class="sx">g/L</span></div></div>
        <div class="field"><label>Mfg cost/sachet</label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-mfg-2" placeholder="2.50" oninput="liveDB(2)"></div></div>
      </div>
      <div class="db-computed">
        <div><div class="dc-l">‚Çπ/kg+GST</div><div class="dc-v tc" id="dc-gst-2">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Cost/litre</div><div class="dc-v" id="dc-litre-2">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Stock Value</div><div class="dc-v oc" id="dc-stock-2">‚Çπ‚Äî</div></div>
      </div>
    </div>
  </div>

  <div class="db-card">
    <div class="db-head head-toilet"><span class="db-icon">üöΩ</span><span class="db-name">Toilet Cleaner</span><span class="db-status empty" id="dbs-3">Not Set</span></div>
    <div class="db-body">
      <div class="two-col">
        <div class="field"><label>Price/kg <span class="gst-badge">excl.GST</span></label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-pkg-3" placeholder="48" oninput="liveDB(3)"></div></div>
        <div class="field"><label>Stock in hand</label><div class="iw sx-in"><input type="number" id="db-stock-3" placeholder="10" oninput="liveDB(3)"><span class="sx">kg</span></div></div>
        <div class="field"><label>Grams per litre</label><div class="iw sx-in"><input type="number" id="db-gpl-3" placeholder="75" oninput="liveDB(3)"><span class="sx">g/L</span></div></div>
        <div class="field"><label>Mfg cost/sachet</label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-mfg-3" placeholder="2.00" oninput="liveDB(3)"></div></div>
      </div>
      <div class="db-computed">
        <div><div class="dc-l">‚Çπ/kg+GST</div><div class="dc-v tc" id="dc-gst-3">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Cost/litre</div><div class="dc-v" id="dc-litre-3">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Stock Value</div><div class="dc-v oc" id="dc-stock-3">‚Çπ‚Äî</div></div>
      </div>
    </div>
  </div>

  <div class="db-card">
    <div class="db-head head-hand"><span class="db-icon">üß¥</span><span class="db-name">Hand Wash Powder</span><span class="db-status empty" id="dbs-4">Not Set</span></div>
    <div class="db-body">
      <div class="two-col">
        <div class="field"><label>Price/kg <span class="gst-badge">excl.GST</span></label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-pkg-4" placeholder="60" oninput="liveDB(4)"></div></div>
        <div class="field"><label>Stock in hand</label><div class="iw sx-in"><input type="number" id="db-stock-4" placeholder="12" oninput="liveDB(4)"><span class="sx">kg</span></div></div>
        <div class="field"><label>Grams per litre</label><div class="iw sx-in"><input type="number" id="db-gpl-4" placeholder="50" oninput="liveDB(4)"><span class="sx">g/L</span></div></div>
        <div class="field"><label>Mfg cost/sachet</label><div class="iw px-in"><span class="px">‚Çπ</span><input type="number" id="db-mfg-4" placeholder="1.80" oninput="liveDB(4)"></div></div>
      </div>
      <div class="db-computed">
        <div><div class="dc-l">‚Çπ/kg+GST</div><div class="dc-v tc" id="dc-gst-4">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Cost/litre</div><div class="dc-v" id="dc-litre-4">‚Çπ‚Äî</div></div>
        <div><div class="dc-l">Stock Value</div><div class="dc-v oc" id="dc-stock-4">‚Çπ‚Äî</div></div>
      </div>
    </div>
  </div>

  <button class="save-btn" onclick="saveDB()">üíæ Save &amp; Sync to Cloud</button>
  <div id="save-msg"></div>

  <div class="share-box">
    <div class="share-title">üì§ Share / Backup</div>
    <div class="share-desc">Export your prices as a file and send via WhatsApp or email. Anyone imports it in one tap.</div>
    <div class="share-btns">
      <button class="sbtn exp" onclick="exportDB()">‚¨á Export File</button>
      <label class="sbtn imp" for="imp-input">‚¨Ü Import File</label>
      <input type="file" id="imp-input" accept=".json" style="display:none" onchange="importDB(event)">
    </div>
    <div id="import-msg"></div>
    <div class="cloud-note">‚òÅÔ∏è <strong>Cloud sync ON.</strong> Anyone who opens this app link sees the same prices in real time.</div>
  </div>

  <div style="text-align:center;margin-top:12px;padding-bottom:4px">
    <button onclick="clearDB()" style="background:none;border:none;color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;text-decoration:underline">üóëÔ∏è Clear all saved data</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: PER SACHET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-single" class="tab-panel">

  <div class="slabel"><span class="snum">1</span> Select Product</div>
  <div class="prod-selector">
    <button class="psel-btn" id="ps-0" onclick="pickSingle(0)"><span class="pi">üßπ</span>Floor</button>
    <button class="psel-btn" id="ps-1" onclick="pickSingle(1)"><span class="pi">üçΩÔ∏è</span>Dish</button>
    <button class="psel-btn" id="ps-2" onclick="pickSingle(2)"><span class="pi">üöø</span>Bath</button>
    <button class="psel-btn" id="ps-3" onclick="pickSingle(3)"><span class="pi">üöΩ</span>Toilet</button>
    <button class="psel-btn" id="ps-4" onclick="pickSingle(4)"><span class="pi">üß¥</span>Hand</button>
  </div>

  <div id="s-fetched" style="display:none">
    <div class="fetched-strip">
      <div class="fs-title" id="s-ftitle">‚Äî</div>
      <div class="fr"><span class="fl">Price/kg excl.GST</span><span class="fv" id="s-fpkg">‚Çπ‚Äî</span></div>
      <div class="fr"><span class="fl">Price/kg incl.18% GST</span><span class="fv tc" id="s-fpgst">‚Çπ‚Äî</span></div>
      <div class="fr"><span class="fl">Grams per litre</span><span class="fv" id="s-fgpl">‚Äî</span></div>
      <div class="fr"><span class="fl">Mfg cost / sachet</span><span class="fv oc" id="s-fmfg">‚Çπ‚Äî</span></div>
      <div class="fr"><span class="fl">Stock available</span><span class="fv gc" id="s-fstock">‚Äî</span></div>
    </div>
  </div>
  <div id="s-notset" class="not-configured" style="display:none">
    <p>Product not configured in database.</p>
    <button class="nc-btn" onclick="showTab('db',document.querySelector('.tab-btn'))">‚Üí Go to Products DB</button>
  </div>

  <div class="slabel"><span class="snum">2</span> Choose Pack Size</div>
  <div class="card">
    <div class="pack-row">
      <button class="pb" onclick="pickPack(250,this)"><span class="pbml">250</span>ml</button>
      <button class="pb" onclick="pickPack(333,this)"><span class="pbml">333</span>ml ‚ÖìL</button>
      <button class="pb" onclick="pickPack(500,this)"><span class="pbml">500</span>ml ¬ΩL</button>
      <button class="pb" onclick="pickPack(750,this)"><span class="pbml">750</span>ml ¬æL</button>
      <button class="pb" onclick="pickPack(1000,this)"><span class="pbml">1L</span>full</button>
    </div>
    <div class="two-col">
      <div class="field"><label>Powder/sachet <span class="auto-badge">AUTO</span></label>
        <div class="iw sx-in"><input type="number" id="s-grams" class="res" readonly><span class="sx" style="color:var(--teal)">g</span></div>
        <div class="hint">g/L √ó pack litres</div></div>
      <div class="field"><label>Pack size (ml)</label>
        <div class="iw sx-in"><input type="number" id="s-ml" placeholder="500" oninput="calcSingle()"><span class="sx">ml</span></div></div>
    </div>
    <div class="how-box">üí° e.g. 80g/L √ó 0.5L pack = <strong>40g</strong> powder per sachet.</div>
    <div class="field"><label>Yield per sachet <span class="auto-badge">AUTO</span></label>
      <div class="iw sx-in"><input type="number" id="s-liters" class="res" readonly><span class="sx" style="color:var(--teal)">L</span></div></div>
  </div>

  <div class="slabel"><span class="snum">3</span> Costs &amp; Margin</div>
  <div class="card">
    <div class="field"><label>Powder cost/sachet <span class="auto-badge">AUTO</span></label>
      <div class="iw px-in"><span class="px" style="color:var(--teal)">‚Çπ</span><input type="number" id="s-landed" class="res" readonly></div></div>
    <div class="field"><label>Mfg cost/sachet <span class="auto-badge">AUTO</span></label>
      <div class="iw px-in"><span class="px" style="color:var(--teal)">‚Çπ</span><input type="number" id="s-prod" class="res" readonly></div></div>
    <div class="field"><label>Your margin %</label>
      <div class="iw sx-in"><input type="number" id="s-margin" placeholder="30" oninput="calcSingle()"><span class="sx">%</span></div></div>
  </div>

  <div class="slabel"><span class="snum">4</span> Result ‚Äî Per Sachet</div>
  <div class="card">
    <div class="rrow"><span class="rl">Powder cost (incl. GST)</span><span class="rv" id="r1">‚Çπ‚Äî</span></div>
    <div class="rrow"><span class="rl">Mfg / production cost</span><span class="rv" id="r2">‚Çπ‚Äî</span></div>
    <div class="rrow"><span class="rl">Total cost (your spend)</span><span class="rv" id="r3">‚Çπ‚Äî</span></div>
    <div class="rrow"><span class="rl">Profit amount</span><span class="rv gc" id="r4">‚Çπ‚Äî</span></div>
    <div class="rpills">
      <div class="rpill tp"><div class="rpl">Selling Price</div><div class="rpv" id="r5">‚Çπ‚Äî</div><div class="rps" id="r5s">‚Äîml pack</div></div>
      <div class="rpill gp"><div class="rpl">Your Profit</div><div class="rpv" id="r6">‚Çπ‚Äî</div><div class="rps" id="r6s">‚Äî% margin</div></div>
    </div>
    <div class="litre-box" id="litre-box" style="display:none">
      <strong>üìä Per-Litre View</strong> ‚Äî Sachet makes <strong id="lb1">‚Äî</strong>L.<br>
      Cost <strong id="lb2">‚Çπ‚Äî</strong> √∑ <span id="lb3">‚Äî</span>L = <strong id="lb4">‚Çπ‚Äî / litre</strong><br>
      Sell <strong id="lb5">‚Çπ‚Äî</strong> √∑ <span id="lb6">‚Äî</span>L = <strong id="lb7">‚Çπ‚Äî / litre</strong>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: BULK ORDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-bulk" class="tab-panel">

  <div class="slabel"><span class="snum">1</span> Select Product</div>
  <div class="prod-selector">
    <button class="psel-btn" id="bp-0" onclick="pickBulk(0)"><span class="pi">üßπ</span>Floor</button>
    <button class="psel-btn" id="bp-1" onclick="pickBulk(1)"><span class="pi">üçΩÔ∏è</span>Dish</button>
    <button class="psel-btn" id="bp-2" onclick="pickBulk(2)"><span class="pi">üöø</span>Bath</button>
    <button class="psel-btn" id="bp-3" onclick="pickBulk(3)"><span class="pi">üöΩ</span>Toilet</button>
    <button class="psel-btn" id="bp-4" onclick="pickBulk(4)"><span class="pi">üß¥</span>Hand</button>
  </div>

  <div id="b-fetched" style="display:none">
    <div class="fetched-strip">
      <div class="fs-title" id="b-ftitle">‚Äî</div>
      <div class="fr"><span class="fl">Price/kg incl.18% GST</span><span class="fv tc" id="b-fpgst">‚Çπ‚Äî</span></div>
      <div class="fr"><span class="fl">Grams per litre</span><span class="fv" id="b-fgpl">‚Äî</span></div>
      <div class="fr"><span class="fl">Mfg cost / sachet</span><span class="fv oc" id="b-fmfg">‚Çπ‚Äî</span></div>
      <div class="fr"><span class="fl">Stock available</span><span class="fv gc" id="b-fstock">‚Äî</span></div>
    </div>
  </div>
  <div id="b-notset" class="not-configured" style="display:none">
    <p>Product not configured in database.</p>
    <button class="nc-btn" onclick="showTab('db',document.querySelector('.tab-btn'))">‚Üí Go to Products DB</button>
  </div>

  <div class="slabel"><span class="snum">2</span> Order Details</div>
  <div class="card">
    <div class="field"><label>Number of sachets</label>
      <div class="iw sx-in"><input type="number" id="b-count" placeholder="20" oninput="calcBulk()" min="1"><span class="sx">pcs</span></div></div>
    <div class="two-col">
      <div class="field"><label>Pack size</label>
        <div class="iw sx-in"><input type="number" id="b-ml" placeholder="500" oninput="calcBulk()"><span class="sx">ml</span></div></div>
      <div class="field"><label>Your margin %</label>
        <div class="iw sx-in"><input type="number" id="b-margin" placeholder="30" oninput="calcBulk()"><span class="sx">%</span></div></div>
      <div class="field"><label>Powder/sachet <span class="auto-badge">AUTO</span></label>
        <div class="iw sx-in"><input type="number" id="b-grams" class="res" readonly><span class="sx" style="color:var(--teal)">g</span></div></div>
      <div class="field"><label>Mfg cost/sachet <span class="auto-badge">AUTO</span></label>
        <div class="iw px-in"><span class="px" style="color:var(--teal)">‚Çπ</span><input type="number" id="b-prod" class="res" readonly></div></div>
    </div>
    <div class="field"><label>Powder cost/sachet <span class="auto-badge">AUTO</span></label>
      <div class="iw px-in"><span class="px" style="color:var(--teal)">‚Çπ</span><input type="number" id="b-landed" class="res" readonly></div></div>
  </div>

  <div class="slabel"><span class="snum">3</span> Bulk Results</div>
  <div class="card">
    <div class="rrow"><span class="rl">Total powder used</span><span class="rv tc" id="br1">‚Äî</span></div>
    <div class="rrow"><span class="rl">Total product yield</span><span class="rv" id="br2">‚Äî</span></div>
    <div class="rrow"><span class="rl">Stock remaining after order</span><span class="rv gc" id="br-stock">‚Äî</span></div>
    <div class="rrow"><span class="rl">Total powder cost (incl.GST)</span><span class="rv" id="br3">‚Çπ‚Äî</span></div>
    <div class="rrow"><span class="rl">Total mfg cost</span><span class="rv" id="br4">‚Çπ‚Äî</span></div>
    <div class="rrow"><span class="rl">Total spend (your cost)</span><span class="rv" id="br5">‚Çπ‚Äî</span></div>
    <div class="rrow"><span class="rl">Total profit</span><span class="rv gc" id="br6">‚Çπ‚Äî</span></div>
    <div class="rpills">
      <div class="rpill tp"><div class="rpl">Total Selling Price</div><div class="rpv" id="br7">‚Çπ‚Äî</div><div class="rps" id="br7s">‚Äî sachets</div></div>
      <div class="rpill op"><div class="rpl">Price / Sachet</div><div class="rpv" id="br8">‚Çπ‚Äî</div><div class="rps" id="br8s">‚Äî</div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: BUNDLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-bundle" class="tab-panel">
  <div class="info-pill">üõí Add multiple products. Each auto-fetches its own data from DB.</div>

  <div class="slabel"><span class="snum">1</span> Products in Bundle</div>
  <div id="bprods"></div>
  <button class="add-btn" onclick="addBundle()">+ Add Product</button>

  <div id="bsummary" style="display:none">
    <div class="slabel"><span class="snum">2</span> Bundle Options</div>
    <div class="card">
      <div class="two-col">
        <div class="field"><label>Override margin %</label>
          <div class="iw sx-in"><input type="number" id="bun-mg" placeholder="Blank=per product" oninput="calcBundle()"><span class="sx">%</span></div></div>
        <div class="field"><label>Customer discount %</label>
          <div class="iw sx-in"><input type="number" id="bun-disc" placeholder="0" oninput="calcBundle()"><span class="sx">%</span></div></div>
      </div>
    </div>

    <div class="slabel"><span class="snum">3</span> Bundle Summary</div>
    <div class="card">
      <div class="rrow"><span class="rl">Total sachets</span><span class="rv tc" id="bn1">‚Äî</span></div>
      <div class="rrow"><span class="rl">Total powder weight</span><span class="rv" id="bn2">‚Äî</span></div>
      <div class="rrow"><span class="rl">Total product yield</span><span class="rv" id="bn3">‚Äî</span></div>
      <div class="rrow"><span class="rl">Total spend (your cost)</span><span class="rv" id="bn4">‚Çπ‚Äî</span></div>
      <div class="rrow"><span class="rl">Customer saves (discount)</span><span class="rv oc" id="bn5">‚Çπ‚Äî</span></div>
      <div class="rrow"><span class="rl">Your profit</span><span class="rv gc" id="bn6">‚Çπ‚Äî</span></div>
      <div class="rrow"><span class="rl">Effective margin</span><span class="rv" id="bn7">‚Äî</span></div>
      <div class="rpills">
        <div class="rpill tp"><div class="rpl">Bundle Price</div><div class="rpv" id="bn8">‚Çπ‚Äî</div><div class="rps" id="bn8s">total</div></div>
        <div class="rpill gp"><div class="rpl">Your Profit</div><div class="rpv" id="bn9">‚Çπ‚Äî</div><div class="rps" id="bn9s">‚Äî% margin</div></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê SUPABASE ‚ïê‚ïê */
const SB_URL = 'https://excvwxbygziimauxjmqt.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4Y3Z3eGJ5Z3ppaW1hdXhqbXF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MzU4NTYsImV4cCI6MjA4NzQxMTg1Nn0.PfrnSJszOze5BMUNSk9X73Zdz888DZSY7hXhzPSPJbQ';
const SB_H   = {'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json','Prefer':'return=minimal'};

/* ‚ïê‚ïê GLOBALS ‚ïê‚ïê */
const GST   = 0.18;
const LS_KEY= 'cleancalc_v3';
const NAMES = ['Floor Cleaner','Dish Wash','Bathroom Cleaner','Toilet Cleaner','Hand Wash Powder'];
const ICONS = ['üßπ','üçΩÔ∏è','üöø','üöΩ','üß¥'];
const HEADS = ['head-floor','head-dish','head-bath','head-toilet','head-hand'];

const f  = (n,d=2)=>(!n||isNaN(n))?'‚Äî':Number(n).toFixed(d);
const fR = n=>(n&&!isNaN(n)&&n>0)?'‚Çπ'+Number(n).toFixed(2):'‚Çπ‚Äî';
const gv = id=>{const v=parseFloat(document.getElementById(id)?.value);return isNaN(v)?0:v;};
const sv = (id,v)=>{const el=document.getElementById(id);if(el)el.value=(v&&!isNaN(v)&&v>0)?Number(v).toFixed(2):'';};
const st = (id,t)=>{const el=document.getElementById(id);if(el)el.textContent=t;};

let db=[null,null,null,null,null];

/* ‚ïê‚ïê BADGE ‚ïê‚ïê */
function badge(s){
  const el=document.getElementById('hbadge');
  const M={synced:'‚òÅÔ∏è Cloud Synced',syncing:'‚è≥ Syncing‚Ä¶',local:'üì± Local Only',empty:'DB Empty',error:'‚ö†Ô∏è Error'};
  el.textContent=M[s]||'DB Empty'; el.className=s||'empty';
}

/* ‚ïê‚ïê POPULATE FIELDS ‚ïê‚ïê */
function populateFields(){
  for(let i=0;i<5;i++){
    if(!db[i]) continue;
    const p=db[i];
    const sf=(id,v)=>{const el=document.getElementById(id);if(el&&v!=null)el.value=Number(v).toFixed(2);};
    sf('db-pkg-'+i,p.pkg); sf('db-stock-'+i,p.stock||0); sf('db-gpl-'+i,p.gpl); sf('db-mfg-'+i,p.mfg);
  }
}

/* ‚ïê‚ïê LOAD FROM CLOUD ‚ïê‚ïê */
async function loadFromCloud(){
  badge('syncing');
  try{
    const res=await fetch(SB_URL+'/rest/v1/products?select=*&order=id',{headers:SB_H});
    if(!res.ok) throw new Error(res.status);
    const rows=await res.json();
    if(!Array.isArray(rows)||rows.length===0){loadFromLocal();return;}
    let any=false;
    rows.forEach(r=>{
      const i=parseInt(r.id);
      if(i>=0&&i<5&&r.pkg>0&&r.gpl>0&&r.mfg>0){db[i]={pkg:+r.pkg,stock:+(r.stock||0),gpl:+r.gpl,mfg:+r.mfg};any=true;}
      else db[i]=null;
    });
    try{localStorage.setItem(LS_KEY,JSON.stringify(db));}catch(e){}
    populateFields(); for(let i=0;i<5;i++) liveDB(i); refreshSel();
    badge(any?'synced':'empty');
  }catch(e){console.warn('Cloud load failed:',e);loadFromLocal();}
}

/* ‚ïê‚ïê LOAD FROM LOCAL ‚ïê‚ïê */
function loadFromLocal(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw){badge('empty');return;}
    const s=JSON.parse(raw);
    if(!Array.isArray(s)||s.length!==5){badge('empty');return;}
    db=s; populateFields(); for(let i=0;i<5;i++) liveDB(i); refreshSel();
    badge(db.some(x=>x!==null)?'local':'empty');
  }catch(e){badge('empty');}
}

/* ‚ïê‚ïê LIVE DB COMPUTED ‚ïê‚ïê */
function liveDB(i){
  const pkg=gv('db-pkg-'+i),stock=gv('db-stock-'+i),gpl=gv('db-gpl-'+i),mfg=gv('db-mfg-'+i);
  const pkgG=pkg*(1+GST), cpl=pkgG>0&&gpl>0?(pkgG/1000)*gpl:0, stV=pkg>0&&stock>0?pkg*stock*(1+GST):0;
  st('dc-gst-'+i,   pkgG>0?'‚Çπ'+f(pkgG):'‚Çπ‚Äî');
  st('dc-litre-'+i, cpl>0?'‚Çπ'+f(cpl):'‚Çπ‚Äî');
  st('dc-stock-'+i, stV>0?'‚Çπ'+f(stV):'‚Çπ‚Äî');
  const b=document.getElementById('dbs-'+i);
  if(b){b.textContent=pkg>0&&gpl>0&&mfg>0?'‚úì Set':'Not Set';b.className='db-status '+(pkg>0&&gpl>0&&mfg>0?'ok':'empty');}
}

/* ‚ïê‚ïê SAVE DB ‚ïê‚ïê */
async function saveDB(){
  for(let i=0;i<5;i++){
    const pkg=gv('db-pkg-'+i),stock=gv('db-stock-'+i),gpl=gv('db-gpl-'+i),mfg=gv('db-mfg-'+i);
    db[i]=(pkg>0&&gpl>0&&mfg>0)?{pkg,stock,gpl,mfg}:null; liveDB(i);
  }
  refreshSel();
  try{localStorage.setItem(LS_KEY,JSON.stringify(db));}catch(e){}
  badge('syncing');
  const msg=document.getElementById('save-msg');
  msg.style.cssText='display:block;color:var(--yellow);text-align:center;font-size:12px;font-weight:700;margin-top:8px';
  msg.textContent='‚è≥ Saving to cloud‚Ä¶';
  try{
    await Promise.all(db.map((p,i)=>{
      if(!p) return Promise.resolve();
      return fetch(SB_URL+'/rest/v1/products?id=eq.'+i,{method:'PATCH',headers:SB_H,body:JSON.stringify({pkg:p.pkg,stock:p.stock||0,gpl:p.gpl,mfg:p.mfg})});
    }));
    badge('synced'); msg.style.color='var(--green)'; msg.textContent='‚úÖ Saved! All devices see these prices now.';
    setTimeout(()=>msg.style.display='none',4000);
  }catch(e){
    badge('local'); msg.style.color='var(--orange)'; msg.textContent='üì± Saved locally. Cloud sync failed.';
    setTimeout(()=>msg.style.display='none',5000);
  }
}

/* ‚ïê‚ïê EXPORT ‚ïê‚ïê */
function exportDB(){
  if(!db.some(x=>x!==null)){alert('No data to export. Fill Products DB first.');return;}
  const data={app:'CleanCalc Pro',exported:new Date().toISOString(),version:3,products:db.map((p,i)=>({id:i,name:NAMES[i],...(p||{})}))};
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
  a.download='cleancalc-'+new Date().toISOString().slice(0,10)+'.json'; a.click();
}

/* ‚ïê‚ïê IMPORT ‚ïê‚ïê */
function importDB(e){
  const file=e.target.files[0]; if(!file) return;
  const msg=document.getElementById('import-msg');
  new FileReader().addEventListener('load',async ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(!data.products||!Array.isArray(data.products)) throw new Error('bad');
      data.products.forEach(p=>{if(p.id>=0&&p.id<5&&p.pkg>0&&p.gpl>0&&p.mfg>0) db[p.id]={pkg:+p.pkg,stock:+(p.stock||0),gpl:+p.gpl,mfg:+p.mfg};});
      populateFields(); for(let i=0;i<5;i++) liveDB(i); refreshSel();
      try{localStorage.setItem(LS_KEY,JSON.stringify(db));}catch(err){}
      msg.style.cssText='display:block;color:var(--green);font-weight:700;text-align:center;margin-top:6px;font-size:12px';
      msg.textContent='‚úÖ Imported! Syncing to cloud‚Ä¶';
      try{
        await Promise.all(db.map((p,i)=>{if(!p)return Promise.resolve();return fetch(SB_URL+'/rest/v1/products?id=eq.'+i,{method:'PATCH',headers:SB_H,body:JSON.stringify({pkg:p.pkg,stock:p.stock||0,gpl:p.gpl,mfg:p.mfg})});}));
        msg.textContent='‚úÖ Imported & synced to cloud!'; badge('synced');
      }catch(err){msg.textContent='‚úÖ Imported locally. Cloud sync failed.'; badge('local');}
      setTimeout(()=>msg.style.display='none',4000);
    }catch(err){
      msg.style.cssText='display:block;color:var(--orange);font-weight:700;text-align:center;margin-top:6px;font-size:12px';
      msg.textContent='‚ùå Invalid file.'; setTimeout(()=>msg.style.display='none',3000);
    }
    e.target.value='';
  },{once:true}).readAsText=function(){};
  const reader=new FileReader();
  reader.onload=async ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(!data.products||!Array.isArray(data.products)) throw new Error('bad');
      data.products.forEach(p=>{if(p.id>=0&&p.id<5&&p.pkg>0&&p.gpl>0&&p.mfg>0) db[p.id]={pkg:+p.pkg,stock:+(p.stock||0),gpl:+p.gpl,mfg:+p.mfg};});
      populateFields(); for(let i=0;i<5;i++) liveDB(i); refreshSel();
      try{localStorage.setItem(LS_KEY,JSON.stringify(db));}catch(err){}
      msg.style.cssText='display:block;color:var(--green);font-weight:700;text-align:center;margin-top:6px;font-size:12px';
      msg.textContent='‚úÖ Imported! Syncing to cloud‚Ä¶';
      try{
        await Promise.all(db.map((p,i)=>{if(!p)return Promise.resolve();return fetch(SB_URL+'/rest/v1/products?id=eq.'+i,{method:'PATCH',headers:SB_H,body:JSON.stringify({pkg:p.pkg,stock:p.stock||0,gpl:p.gpl,mfg:p.mfg})});}));
        msg.textContent='‚úÖ Imported & synced to cloud!'; badge('synced');
      }catch(err){msg.textContent='‚úÖ Imported locally.'; badge('local');}
      setTimeout(()=>msg.style.display='none',4000);
    }catch(err){
      msg.style.cssText='display:block;color:var(--orange);font-weight:700;text-align:center;margin-top:6px;font-size:12px';
      msg.textContent='‚ùå Invalid file.'; setTimeout(()=>msg.style.display='none',3000);
    }
    e.target.value='';
  };
  reader.readAsText(file);
}

/* ‚ïê‚ïê CLEAR ‚ïê‚ïê */
async function clearDB(){
  if(!confirm('Clear all product data from device and cloud? Cannot be undone.')) return;
  localStorage.removeItem(LS_KEY); db=[null,null,null,null,null];
  for(let i=0;i<5;i++){['db-pkg','db-stock','db-gpl','db-mfg'].forEach(k=>{const el=document.getElementById(k+'-'+i);if(el)el.value='';});liveDB(i);}
  refreshSel(); badge('empty');
  try{await Promise.all([0,1,2,3,4].map(i=>fetch(SB_URL+'/rest/v1/products?id=eq.'+i,{method:'PATCH',headers:SB_H,body:JSON.stringify({pkg:null,stock:null,gpl:null,mfg:null})})));}catch(e){}
  alert('All data cleared.');
}

/* ‚ïê‚ïê REFRESH SELECTORS ‚ïê‚ïê */
function refreshSel(){
  for(let i=0;i<5;i++){
    document.getElementById('ps-'+i)?.classList.toggle('unset',!db[i]);
    document.getElementById('bp-'+i)?.classList.toggle('unset',!db[i]);
  }
}

/* ‚ïê‚ïê PER SACHET ‚ïê‚ïê */
let sProd=-1;
function pickSingle(i){
  sProd=i;
  document.querySelectorAll('[id^="ps-"]').forEach(b=>b.classList.remove('sel'));
  document.getElementById('ps-'+i).classList.add('sel');
  const sf=document.getElementById('s-fetched'),sns=document.getElementById('s-notset');
  if(!db[i]){sf.style.display='none';sns.style.display='block';return;}
  sf.style.display='block';sns.style.display='none';
  const p=db[i],g=p.pkg*(1+GST);
  st('s-ftitle',ICONS[i]+' '+NAMES[i]+' ‚Äî from DB');
  st('s-fpkg','‚Çπ'+f(p.pkg)); st('s-fpgst','‚Çπ'+f(g));
  st('s-fgpl',f(p.gpl)+' g/L'); st('s-fmfg','‚Çπ'+f(p.mfg));
  st('s-fstock',p.stock>0?f(p.stock)+' kg':'‚Äî');
  calcSingle();
}

function pickPack(ml,btn){
  document.querySelectorAll('.pb').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
  document.getElementById('s-ml').value=ml;
  calcSingle();
}

function calcSingle(){
  const ml=gv('s-ml'),mg=gv('s-margin'),lit=ml>0?ml/1000:0;
  sv('s-liters',lit>0?lit:null);
  let pkgG=0,mfg=0,grams=0;
  if(sProd>=0&&db[sProd]){const p=db[sProd];pkgG=p.pkg*(1+GST);mfg=p.mfg;grams=lit>0?p.gpl*lit:0;}
  sv('s-grams',grams>0?grams:null);
  const pwd=pkgG>0&&grams>0?(pkgG/1000)*grams:0;
  sv('s-landed',pwd>0?pwd:null); sv('s-prod',mfg>0?mfg:null);
  const tot=pwd+mfg,prof=tot*(mg/100),sell=tot+prof;
  const cpl=lit>0?tot/lit:0,spl=lit>0?sell/lit:0;
  st('r1',fR(pwd)); st('r2',mfg>0?fR(mfg):'‚Çπ‚Äî'); st('r3',fR(tot)); st('r4',prof>0?fR(prof):'‚Çπ‚Äî');
  st('r5',fR(sell)); st('r5s',ml>0?ml+'ml pack':'‚Äîml pack');
  st('r6',sell>0?fR(sell-tot):'‚Çπ‚Äî'); st('r6s',mg>0?mg+'% margin':'‚Äî% margin');
  const lb=document.getElementById('litre-box');
  if(lit>0&&tot>0){
    lb.style.display='block';
    st('lb1',f(lit));st('lb2',fR(tot));st('lb3',f(lit));st('lb4','‚Çπ'+f(cpl)+' / litre');
    st('lb5',fR(sell));st('lb6',f(lit));st('lb7','‚Çπ'+f(spl)+' / litre');
  }else lb.style.display='none';
}

/* ‚ïê‚ïê BULK ORDER ‚ïê‚ïê */
let bProd=-1;
function pickBulk(i){
  bProd=i;
  document.querySelectorAll('[id^="bp-"]').forEach(b=>b.classList.remove('sel'));
  document.getElementById('bp-'+i).classList.add('sel');
  const bf=document.getElementById('b-fetched'),bns=document.getElementById('b-notset');
  if(!db[i]){bf.style.display='none';bns.style.display='block';calcBulk();return;}
  bf.style.display='block';bns.style.display='none';
  const p=db[i],g=p.pkg*(1+GST);
  st('b-ftitle',ICONS[i]+' '+NAMES[i]);
  st('b-fpgst','‚Çπ'+f(g)); st('b-fgpl',f(p.gpl)+' g/L');
  st('b-fmfg','‚Çπ'+f(p.mfg)); st('b-fstock',p.stock>0?f(p.stock)+' kg':'‚Äî');
  calcBulk();
}

function calcBulk(){
  const n=gv('b-count'),ml=gv('b-ml'),mg=gv('b-margin'),lit=ml>0?ml/1000:0;
  let pkgG=0,gpl=0,mfg=0,stk=0;
  if(bProd>=0&&db[bProd]){const p=db[bProd];pkgG=p.pkg*(1+GST);gpl=p.gpl;mfg=p.mfg;stk=p.stock||0;}
  const gEa=lit>0?gpl*lit:0,pEa=pkgG>0&&gEa>0?(pkgG/1000)*gEa:0;
  sv('b-grams',gEa>0?gEa:null); sv('b-prod',mfg>0?mfg:null); sv('b-landed',pEa>0?pEa:null);
  const tG=n*gEa,tL=n*lit,tLd=n*pEa,tPd=n*mfg,tC=tLd+tPd;
  const sell=tC*(1+mg/100),perS=n>0?sell/n:0,profS=n>0?(sell-tC)/n:0;
  const stLeft=stk>0&&tG>0?stk-(tG/1000):null;
  st('br1',tG>0?f(tG)+'g ('+f(tG/1000)+'kg)':'‚Äî');
  st('br2',tL>0?f(tL)+' litres':'‚Äî');
  st('br-stock',stLeft!==null?(stLeft>=0?f(stLeft)+' kg remaining':'‚ö†Ô∏è Not enough stock!'):'‚Äî');
  st('br3',fR(tLd));st('br4',fR(tPd));st('br5',fR(tC));st('br6',fR(sell-tC));
  st('br7',fR(sell));st('br7s',n>0?n+' sachets':'‚Äî');
  st('br8',fR(perS));st('br8s',profS>0?'‚Çπ'+f(profS)+' profit each':'‚Äî');
}

/* ‚ïê‚ïê BUNDLE ‚ïê‚ïê */
let bItems=[],nid=1;
function addBundle(){bItems.push(nid++);renderBundle();}
function removeBundle(id){
  bItems=bItems.filter(x=>x!==id);
  document.getElementById('bpc-'+id)?.remove();
  document.getElementById('bsummary').style.display=bItems.length>0?'block':'none';
  document.querySelectorAll('.bpnum').forEach((el,i)=>el.textContent=i+1);
  calcBundle();
}
function renderBundle(){
  const c=document.getElementById('bprods');
  bItems.forEach(id=>{
    if(document.getElementById('bpc-'+id)) return;
    const d=document.createElement('div');
    d.className='bpcard';d.id='bpc-'+id;
    d.innerHTML=
      '<div class="bphead '+HEADS[0]+'" id="bph-'+id+'">'
        +'<div class="bpnum">1</div>'
        +'<select id="bpsel-'+id+'" onchange="onBC('+id+')">'
          +NAMES.map((n,i)=>'<option value="'+i+'">'+ICONS[i]+' '+n+'</option>').join('')
        +'</select>'
        +'<button class="rmbtn" onclick="removeBundle('+id+')">‚úï</button>'
      +'</div>'
      +'<div class="bpbody">'
        +'<div class="bp-mini">'
          +'<div><div class="bm-l">‚Çπ/kg+GST</div><div class="bm-v tc" id="bpkg-'+id+'">‚Äî</div></div>'
          +'<div><div class="bm-l">g/L</div><div class="bm-v" id="bgpl-'+id+'">‚Äî</div></div>'
          +'<div><div class="bm-l">Mfg/sachet</div><div class="bm-v" id="bmfg-'+id+'">‚Äî</div></div>'
        +'</div>'
        +'<div class="two-col">'
          +'<div class="field"><label>Sachets</label><div class="iw sx-in"><input type="number" id="bpq-'+id+'" value="1" min="1" oninput="calcBundle()"><span class="sx">pcs</span></div></div>'
          +'<div class="field"><label>Pack size</label><div class="iw sx-in"><input type="number" id="bpml-'+id+'" placeholder="500" oninput="calcBundle()"><span class="sx">ml</span></div></div>'
          +'<div class="field"><label>Margin %</label><div class="iw sx-in"><input type="number" id="bpmg-'+id+'" placeholder="30" oninput="calcBundle()"><span class="sx">%</span></div></div>'
          +'<div class="field"><label>Pwd cost/pc <span class="auto-badge">AUTO</span></label><div class="iw px-in"><span class="px" style="color:var(--teal)">‚Çπ</span><input type="number" id="bpld-'+id+'" class="res" readonly></div></div>'
        +'</div>'
        +'<div class="prod-result"><span class="prl" id="bplbl-'+id+'">Pick pack size to calculate</span><span class="prv" id="bpval-'+id+'">‚Çπ‚Äî</span></div>'
      +'</div>';
    c.appendChild(d);
    onBC(id);
  });
  document.querySelectorAll('.bpnum').forEach((el,i)=>el.textContent=i+1);
  document.getElementById('bsummary').style.display=bItems.length>0?'block':'none';
  calcBundle();
}
function onBC(id){
  const sel=document.getElementById('bpsel-'+id);if(!sel)return;
  const i=parseInt(sel.value);
  const h=document.getElementById('bph-'+id);if(h)h.className='bphead '+HEADS[i];
  if(db[i]){const p=db[i],g=p.pkg*(1+GST);st('bpkg-'+id,'‚Çπ'+f(g));st('bgpl-'+id,f(p.gpl)+'g/L');st('bmfg-'+id,'‚Çπ'+f(p.mfg));}
  else{st('bpkg-'+id,'‚Äî');st('bgpl-'+id,'‚Äî');st('bmfg-'+id,'‚Äî');}
  calcBundle();
}
function calcBundle(){
  let tG=0,tL=0,tLd=0,tMfg=0,tSell=0,tS=0;
  bItems.forEach(id=>{
    const sel=document.getElementById('bpsel-'+id);if(!sel)return;
    const i=parseInt(sel.value);
    const qty=parseFloat(document.getElementById('bpq-'+id)?.value)||0;
    const ml=parseFloat(document.getElementById('bpml-'+id)?.value)||0;
    const mg=parseFloat(document.getElementById('bpmg-'+id)?.value)||0;
    const lit=ml>0?ml/1000:0;
    let pkgG=0,gpl=0,mfg=0;
    if(db[i]){const p=db[i];pkgG=p.pkg*(1+GST);gpl=p.gpl;mfg=p.mfg;}
    const gEa=lit>0?gpl*lit:0,pEa=pkgG>0&&gEa>0?(pkgG/1000)*gEa:0;
    sv('bpld-'+id,pEa>0?pEa:null);
    tS+=qty;tG+=qty*gEa;tL+=qty*lit;tLd+=qty*pEa;tMfg+=qty*mfg;
    const pC=(pEa+mfg)*qty,pSell=pC*(1+mg/100);tSell+=pSell;
    const lbl=document.getElementById('bplbl-'+id),val=document.getElementById('bpval-'+id);
    if(lbl&&val){
      if(pSell>0){lbl.textContent=qty+'pcs √ó '+ml+'ml ‚Äî cost ‚Çπ'+f(pC)+' ‚Äî profit ‚Çπ'+f(pSell-pC);val.textContent='‚Çπ'+f(pSell);}
      else{lbl.textContent='Pick pack size to calculate';val.textContent='‚Çπ‚Äî';}
    }
  });
  const tC=tLd+tMfg;
  const bunMg=parseFloat(document.getElementById('bun-mg')?.value);
  const disc=parseFloat(document.getElementById('bun-disc')?.value)||0;
  let base=isNaN(bunMg)?tSell:tC*(1+bunMg/100);
  const dAmt=base*(disc/100),final=base-dAmt,profit=final-tC,eff=tC>0?(profit/tC)*100:0;
  st('bn1',tS>0?tS+' sachets':'‚Äî');st('bn2',tG>0?f(tG)+'g / '+f(tG/1000)+'kg':'‚Äî');st('bn3',tL>0?f(tL)+' litres':'‚Äî');
  st('bn4',fR(tC));st('bn5',dAmt>0?fR(dAmt):'‚Çπ0.00');st('bn6',fR(profit));st('bn7',tC>0?f(eff)+'%':'‚Äî');
  st('bn8',fR(final));st('bn8s',tS>0?tS+' sachets total':'total');
  st('bn9',fR(profit));st('bn9s',tC>0?f(eff)+'% margin':'‚Äî');
}

/* ‚ïê‚ïê TABS ‚ïê‚ïê */
function showTab(name,btn){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  btn.classList.add('active');
}

/* ‚ïê‚ïê STARTUP ‚ïê‚ïê */
document.addEventListener('DOMContentLoaded',()=>loadFromCloud());
</script>
</body>
</html>
